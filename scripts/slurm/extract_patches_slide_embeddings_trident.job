#!/bin/bash

#SBATCH --job-name=trident_extraction  # Job name for identification
#SBATCH --partition=gpu_h100         # Specify the GPU partition
#SBATCH --time=12:00:00              # Maximum run time (12 hours)
#SBATCH --gpus=1                     # Request 1 GPU
#SBATCH --output=trident_%j.out      # Standard output log file
#SBATCH --error=trident_%j.err       # Standard error log file

# --- Job Setup ---
echo "=========================================================="
echo "Job started on $(date)"
echo "Job ID: $SLURM_JOB_ID"
echo "Running on nodes: $SLURM_JOB_NODELIST"
echo "GPU(s) allocated: $CUDA_VISIBLE_DEVICES"
echo "=========================================================="

# --- Load Required Modules ---
# NOTE: Adjust these modules if 'trident_venv' has different dependencies
# These are based on your first example script.
echo "Loading modules..."
module purge
module load 2024
module load cuDNN/9.5.0.50-CUDA-12.6.0
echo "Modules loaded."

# --- Execute the Application ---

# Navigate to the base project directory
cd /projects/0/prjs1597/LMM/
echo "Changed directory to $(pwd)"

# Activate the Python virtual environment
echo "Activating virtual environment 'trident_venv'..."
source trident_venv/bin/activate
echo "Environment activated."

# Navigate to the 'trident' source directory
cd trident
echo "Changed directory to $(pwd)"

# --- Task 1: get patch coords ---
# echo "----------------------------------------------------------"
# echo "Starting Task 1: Extracting conch (task all)..."
# echo "----------------------------------------------------------"
# python run_batch_of_slides.py \
#     --segmenter hest  \
#     --wsi_dir ../data/raw/HE_revision_24_10_25/ \
#     --job_dir ../data/processed/revision_24_10_25/trident_conch_embeddings \
#     --task all \
#     --patch_encoder conch_v15 \
#     --mag 20 \
#     --patch_size 512 \
#     --search_nested

# echo "Task 1 complete."

# --- Task 2: Extract conch ---
# echo "----------------------------------------------------------"
# echo "Starting Task 1: Extracting conch (task feat)..."
# echo "----------------------------------------------------------"
# python run_batch_of_slides.py \
#     --wsi_dir ../data/raw/HE_revision_24_10_25/ \
#     --job_dir ../data/processed/revision_24_10_25/trident_conch_embeddings \
#     --task feat \
#     --patch_encoder conch_v15 \
#     --mag 20 \
#     --patch_size 512 \
#     --search_nested \
#     --batch_size 1

# echo "Task 2 complete."

# --- Task 3: Extract slides ---
echo "----------------------------------------------------------"
echo "Starting Task 2: Extracting slide features (task feat)..."
echo "----------------------------------------------------------"
python run_batch_of_slides.py \
    --task feat \
    --wsi_dir ../data/raw/HE_revision_24_10_25/ \
    --job_dir ../data/processed/revision_24_10_25/trident_conch_embeddings/ \
    --slide_encoder titan \
    --mag 20 \
    --patch_size 512 \
    --batch_size 1 \
    --search_nested 

echo "Task 3 complete."

# --- Job Completion ---
echo "=========================================================="
echo "Job finished on $(date)"
echo "=========================================================="
