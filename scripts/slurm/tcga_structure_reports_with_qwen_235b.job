#!/bin/bash

#SBATCH --job-name=process_reports  # Job name for identification
#SBATCH --partition=gpu_h100        # Specify the GPU partition
#SBATCH --time=06:00:00             # Maximum run time (6 hours)
#SBATCH --gpus=2                    # Request 2 GPUs
#SBATCH --output=reports_%j.out     # Standard output log file
#SBATCH --error=reports_%j.err      # Standard error log file

# --- Job Setup ---
echo "=========================================================="
echo "Job started on $(date)"
echo "Job ID: $SLURM_JOB_ID"
echo "Running on nodes: $SLURM_JOB_NODELIST"
echo "=========================================================="

# --- Load Required Modules ---
# Clears any previously loaded modules and loads the specified environment
echo "module loads"
module purge
module load 2024
module load CMake/3.29.3-GCCcore-13.3.0
module load OpenSSL/3
module load cuDNN/9.5.0.50-CUDA-12.6.0

# --- Execute the Application ---
# Navigate to the source directory
cd /projects/0/prjs1597/LMM/MLLM_BARRETT/src

# Activate the Python virtual environment
echo "Load in the environment"
source ../../venv/bin/activate

echo "Structuring the reports with Qwen3-235b"
# Run the Python script
# Note: Your script is set to use a single GPU with '--gpu 0'.
# If you want to utilize both requested GPUs, your script may need modifications.
python -m process_reports.process_reports_task \
    --config ./configs/barrett/gguf/qwen3-235b-a22-GGUF.yaml \
    --task tcga_structure_reports \
    --input_key "cleaned_reports" \
    --output_key "tcga_structured" \
    --prompt_path ./configs/prompts/barrett/summarize_reports_tcga_format.txt \
    --input_json ../../data/processed/json/cleaned/qwen_235b_cleaned_4.json \
    --output_json ../../data/processed/json/qwen_235b_tcga_structured_barrett.json \
    --batch_size 1 \
    --num_variations 1 \
    --gpu 0 \
    --parse_out_thinking

# --- Job Completion ---
echo "=========================================================="
echo "Job finished on $(date)"
echo "=========================================================="
