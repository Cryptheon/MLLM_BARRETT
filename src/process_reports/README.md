# Pathology Report Batch Processing with Local LLM

This repository contains scripts to batch-process pathology reports using a locally hosted language model (`unsloth`). The model cleans and reformats pathology reports according to a user-defined prompt stored in a `.txt` file.

---

## Scripts Overview

### 1. process_pathology_reports.py

This script uses a local LLM to process pathology reports in batches. The prompt used to instruct the model lives in a separate `.txt` file, and the reports are read from a CSV.

**Functionality:**
- Loads a base prompt from a `.txt` file.
- Uses a local model via `unsloth.FastLanguageModel`.
- Processes the text column in a CSV file in batches.
- Can generate multiple variations of each cleaned report.
- Outputs a CSV with the original and processed reports.

**Input CSV format:**
The input CSV must contain at least the following columns:
- `patient_filename`: A unique identifier (e.g., `TCGA-BP-5195.25c0b433-5557-4165-922e-2c1eac9c26f0`)
- `text`: The raw pathology report text to be processed

**Example `text` value:**
```
Date of Receipt: Clinical Diagnosis & History: Incidental 3 cm left upper pole renal mass. Specimens Submitted: 1: Kidney, Left Upper Pole; Partial Nephrectomy. DIAGNOSIS: ...
```

**Running the script:**
```
python process_pathology_reports.py \
  --config config.yaml \
  --prompt_path prompt.txt \
  --input_csv script_tests/data_test/test_input.csv \
  --output_csv processed_output.csv \
  --column text \
  --batch_size 4 \
  --num_variations 1
```

**Output:**
A new CSV is created with a column `processed_outputs` containing the cleaned reports.

---

### 2. script_tests/test_pathology_script.py

This test script automates the testing of the main script using a small sample report and prompt.

**Functionality:**
- Reads test input from `test_report.txt` and `test_prompt.txt`.
- Converts the test report into a CSV format expected by the main script.
- Runs the main script using this test input.
- Verifies that an output file is created and prints the first few results.

**File Structure:**
```
script_tests/
  ├── test_pathology_script.py
  ├── test_report.txt         # Sample report text
  ├── test_prompt.txt         # Sample prompt
  └── data_test/
        └── test_input.csv    # Auto-generated by the test script
```

**Running the test:**
```
python script_tests/test_pathology_script.py
```

**Output:**
- `test_output.csv`: A file with the processed report
- Prints preview of the output

---

## Notes & Tips

- **Prompt Formatting:** Your `prompt.txt` should contain a Python `.format()` placeholder, e.g.:
  ```
  Please clean and reformat the following pathology report:\n{text}
  ```
- **Model Requirements:** The script expects a local `FastLanguageModel` compatible with `unsloth`. Make sure your config YAML includes fields like `model_name`, `max_seq_length`, `temperature`, and `max_new_tokens`.
- **Multiple Outputs:** You can generate more than one variation per input using `--num_variations`.
---


